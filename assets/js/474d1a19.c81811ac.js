"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[5823],{3504:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var i=t(5893),l=t(1151);const o={},s="Policy Development",a={id:"knowledge_base/policy_development",title:"Policy Development",description:"Creating a local policy development environment",source:"@site/../docs/knowledge_base/policy_development.md",sourceDirName:"knowledge_base",slug:"/knowledge_base/policy_development",permalink:"/knowledge_base/policy_development",draft:!1,unlisted:!1,editUrl:"https://github.com/phylum-dev/documentation/edit/main/docs/knowledge_base/policy_development.md",tags:[],version:"current",lastUpdatedBy:"phylum-bot",lastUpdatedAt:1704213001,formattedLastUpdatedAt:"Jan 2, 2024",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Policy Basics",permalink:"/knowledge_base/policy_basics"},next:{title:"Policy Examples",permalink:"/knowledge_base/policy_examples"}},d={},c=[{value:"Creating a local policy development environment",id:"creating-a-local-policy-development-environment",level:2},{value:"Download the OPA CLI",id:"download-the-opa-cli",level:3},{value:"Download the policy SDK",id:"download-the-policy-sdk",level:3},{value:"Download input data",id:"download-input-data",level:3},{value:"Evaluating policies locally",id:"evaluating-policies-locally",level:2},{value:"Automated testing",id:"automated-testing",level:2},{value:"Evaluating policies using the Phylum API",id:"evaluating-policies-using-the-phylum-api",level:2}];function r(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,l.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"policy-development",children:"Policy Development"}),"\n",(0,i.jsx)(n.h2,{id:"creating-a-local-policy-development-environment",children:"Creating a local policy development environment"}),"\n",(0,i.jsx)(n.p,{children:"It is recommended to set up a local development environment for a better policy development experience. With a local development environment, you gain benefits such as faster feedback, more diagnostic abilities, version control, and automated testing."}),"\n",(0,i.jsx)(n.h3,{id:"download-the-opa-cli",children:"Download the OPA CLI"}),"\n",(0,i.jsxs)(n.p,{children:["Follow the instructions at ",(0,i.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/#1-download-opa",children:"www.openpolicyagent.org"})," to\ndownload a copy of the OPA command line tool and run ",(0,i.jsx)(n.code,{children:"opa version"})," to ensure it is working."]}),"\n",(0,i.jsx)(n.h3,{id:"download-the-policy-sdk",children:"Download the policy SDK"}),"\n",(0,i.jsxs)(n.p,{children:["Download the policy SDK from ",(0,i.jsx)(n.a,{href:"https://api.phylum.io/api/v0/data/jobs/policy/sdk.zip",children:"the Phylum API endpoint"})," and\nextract it."]}),"\n",(0,i.jsx)(n.h3,{id:"download-input-data",children:"Download input data"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'job="YOUR JOB ID"\ntoken=$(phylum auth token -b)\ncurl -H "Authorization: Bearer ${token}" "https://api.phylum.io/api/v0/data/jobs/${job}/policy/input" -fo input.json\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Note: You can obtain a Job ID by using the ",(0,i.jsx)(n.a,{href:"/cli/commands/phylum_history",children:(0,i.jsx)(n.code,{children:"phylum history"})})," command from the Phylum CLI."]}),"\n",(0,i.jsx)(n.h2,{id:"evaluating-policies-locally",children:"Evaluating policies locally"}),"\n",(0,i.jsxs)(n.p,{children:["A policy can be evaluated using ",(0,i.jsx)(n.code,{children:"opa eval --data phylum.rego --data <YOUR POLICY>.rego --data constants.json --input input.json --schema schema --format pretty data.phylum.job"}),"."]}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Input"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Provider"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"phylum.rego"})}),(0,i.jsx)(n.td,{children:"defines rules for jobs, dependencies, and issues"}),(0,i.jsx)(n.td,{children:"Phylum"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"<YOUR POLICY>.rego"})}),(0,i.jsx)(n.td,{children:"policy you want to test"}),(0,i.jsx)(n.td,{children:"User"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"constants.json"})}),(0,i.jsx)(n.td,{children:"constants that can be used in your custom policy"}),(0,i.jsx)(n.td,{children:"Phylum"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"input.json"})}),(0,i.jsx)(n.td,{children:"input data to evaluate, generally from a Phylum job response"}),(0,i.jsx)(n.td,{children:"User"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"schema"})}),(0,i.jsx)(n.td,{children:"location of the schema files"}),(0,i.jsx)(n.td,{children:"Phylum"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"data.phylum.job"})}),(0,i.jsx)(n.td,{children:"entry point"}),(0,i.jsx)(n.td,{children:"Static value"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["If everything is working, you will receive JSON output from ",(0,i.jsx)(n.code,{children:"opa"})," that looks like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "dependencies": [],\n  "errors": []\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"This is what the output looks like when the job is allowed by the policy. When the policy blocks something, there will be additional data describing the failure."}),"\n",(0,i.jsx)(n.h2,{id:"automated-testing",children:"Automated testing"}),"\n",(0,i.jsxs)(n.p,{children:["Open Policy Agent has documentation on ",(0,i.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/policy-testing/",children:"policy testing"}),". Writing an automated test for your Phylum policy looks something like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rego",children:'# example_test.rego\n# This is a test for the default.rego which blocks high/critical severity issues.\n\npackage policy\n\nimport data.phylum.level\nimport future.keywords.if\n\ntest_block_high if {\n    # Mock input\n    check := issue with data.issue as {\n        "tag": "tag",\n        "severity": level.HIGH\n    }\n    # Evaluate if the set contains the expected result\n    check == {"risk level cannot exceed medium"}\n}\n\ntest_allow_medium if {\n    # Mock input\n    check := issue with data.issue as {\n        "tag": "tag",\n        "severity": level.MEDIUM\n    }\n    # Evaluate if the set is empty\n    check == set()\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This test requires ",(0,i.jsx)(n.code,{children:"constants.json"})," from the Phylum SDK. The test can be executed against the Phylum ",(0,i.jsx)(n.code,{children:"default.rego"})," policy using ",(0,i.jsx)(n.code,{children:"opa test constants.json default.rego example_test.rego"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"evaluating-policies-using-the-phylum-api",children:"Evaluating policies using the Phylum API"}),"\n",(0,i.jsxs)(n.p,{children:["Using the ",(0,i.jsx)(n.a,{href:"https://api.phylum.io/api/v0/swagger/index.html#/Jobs/evaluate_policy",children:(0,i.jsx)(n.code,{children:"evaluate_policy"})})," API, it's possible to evaluate policies within Phylum. This is the same API used by Phylum tooling."]}),"\n",(0,i.jsxs)(n.p,{children:["To evaluate an existing job using ",(0,i.jsx)(n.code,{children:"example.rego"})," you can make an API call like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sh",children:'curl -H "Authorization: Bearer $(phylum auth token -b)" -H "Content-Type: text/plain" --data-binary @example.rego https://api.phylum.io/api/v0/data/jobs/YOUR_JOB_ID/policy/evaluate\n'})}),"\n",(0,i.jsx)(n.p,{children:"If the endpoint is called with no body, the project's saved policy will be used."}),"\n",(0,i.jsx)(n.p,{children:"If policy evaluation is successful, the result will contain both the policy output as well as a generated report in Markdown format."}),"\n",(0,i.jsx)(n.p,{children:"Issues and dependencies that have been suppressed via project preferences are visible in the policy input, but rejections related to those issues or dependencies will not be included in the Markdown report."}),"\n",(0,i.jsxs)(n.p,{children:["Dependencies that are ignored via the ",(0,i.jsx)(n.code,{children:"ignored_packages"})," parameter are filtered out before applying the policy and will not be visible in the policy input or output."]})]})}function h(e={}){const{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(r,{...e})}):r(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>s});var i=t(7294);const l={},o=i.createContext(l);function s(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);